var Bootstrapper=function(){this.serializeParams=function(params){if("object"==typeof params&&0<Object.keys(params).length){var str=[];for(var p in params)params.hasOwnProperty(p)&&str.push(encodeURIComponent(p)+"="+encodeURIComponent(params[p]));return str.join("&")}return null},this.doRequest=function(type,url,params){return params=this.serializeParams(params),new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.timeout=5e3,xhr.onload=function(){try{var response=JSON.parse(this.responseText);resolve(response)}catch(e){reject("Received data is not a valid JSON object!")}},xhr.onerror=function(){reject()},xhr.timeout=function(){reject()},"GET"===type&&params?url+="?"+params:0<=["POST","PUT"].indexOf(type)&&xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xhr.overrideMimeType("application/json"),xhr.open(type,url,!0),xhr.send(params)})},this.getLocale=function(){return new Promise(function(resolve){var locale="en-AU";this.doRequest("GET",window.app.api.base+"/v1/geolocation/visitor-config",{website_id:window.websiteId}).then(function(response){"object"==typeof response.data&&response.data.hasOwnProperty("locale")&&"string"==typeof response.data.locale&&(locale=response.data.locale),resolve(locale)},function(){resolve(locale)})}.bind(this))},this.getLoggedInStatus=function(){return new Promise(function(resolve){this.doRequest("GET","/ajax/login/status").then(function(response){resolve(!!+response.status)},function(){resolve(!1)})}.bind(this))},this.validateLocale=function(userLocale,configLocale){var locale=[];return userLocale=userLocale.split("-"),configLocale=configLocale.split("-"),void 0!==userLocale[0]||Array.isArray(window.app.languages)&&-1===window.app.languages.indexOf(userLocale[0])?locale.push(configLocale[0]):locale.push(userLocale[0]),void 0!==configLocale[1]&&locale.push(configLocale[1]),locale.join("-")},this.initialise=function(){return Promise.all([this.getLocale(),this.getLoggedInStatus()]).then(function(responses){var redirectUri=[],locPathName=window.location.pathname.replace(/^\//,"").replace(/\/$/,"");locPathName.length?(locPathName=locPathName.split("/")).length&&(new RegExp("^([a-zA-Z]{2})(?:-([a-zA-Z]{2}))?$","g").test(locPathName[0])?(locPathName[0]=this.validateLocale(locPathName[0],responses[0]),redirectUri=locPathName):(redirectUri.push(responses[0]),redirectUri=redirectUri.concat(locPathName))):redirectUri.push(responses[0]),responses[1]?"members"!==redirectUri[1]&&redirectUri.splice(1,0,"members"):"members"===redirectUri[1]&&redirectUri.splice(1,1),window.location.search&&redirectUri.push(window.location.search),redirectUri=redirectUri.join("/"),window.location.href="https://"+window.location.hostname+"/"+redirectUri}.bind(this))}};(new Bootstrapper).initialise();